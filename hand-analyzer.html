<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أداة تسجيل حركات اليد</title>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            gap: 20px;
            height: 100vh;
            margin: 0;
            padding: 20px;
            background-color: #2d3436;
            color: white;
            box-sizing: border-box;
        }
        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .video-container {
            position: relative;
            width: 640px;
            height: 480px;
            border: 3px solid #0984e3;
        }
        video, canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
        }
        h1 { color: #0984e3; margin-top: 0; }
        .controls button {
            padding: 10px 20px;
            font-size: 16px;
            font-family: 'Cairo', sans-serif;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #startButton { background-color: #2ecc71; color: white; }
        #stopButton { background-color: #e74c3c; color: white; }
        #stopButton:disabled { background-color: #95a5a6; cursor: not-allowed; }
        #status {
            margin-top: 10px;
            font-size: 18px;
            color: #fdcb6e;
            height: 25px;
        }
        .data-container {
            width: 350px;
            height: 600px;
            background-color: #636e72;
            padding: 15px;
            border-radius: 8px;
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 12px;
            border: 2px solid #b2bec3;
        }
        .data-container h2 { margin-top: 0; text-align: center; color: #dfe6e9; border-bottom: 1px solid #dfe6e9; padding-bottom: 10px; }
        pre { white-space: pre-wrap; word-wrap: break-word; color: #fdcb6e; }
    </style>
</head>
<body>
    <div class="main-container">
        <h1>أداة تسجيل حركات اليد</h1>
        <div class="video-container">
            <video id="webcam" autoplay playsinline></video>
            <canvas id="outputCanvas"></canvas>
        </div>
        <div class="controls">
            <button id="startButton">▶ ابدأ التسجيل</button>
            <button id="stopButton" disabled>⏹ إيقاف وحفظ</button>
        </div>
        <div id="status">الحالة: جاهز</div>
    </div>

    <div class="data-container">
        <h2>بيانات الإطار الحالي</h2>
        <pre id="landmarks-data">في انتظار اكتشاف يد...</pre>
    </div>

    <!-- استيراد مكتبات MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script>
        const videoElement = document.getElementById('webcam' );
        const canvasElement = document.getElementById('outputCanvas');
        const canvasCtx = canvasElement.getContext('2d');
        const landmarksDataElement = document.getElementById('landmarks-data');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const statusElement = document.getElementById('status');

        let isRecording = false;
        let recordedFrames = [];

        function onResults(results) {
            // --- جزء الرسم (لا تغيير) ---
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            if (results.multiHandLandmarks) {
                for (const landmarks of results.multiHandLandmarks) {
                    drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, { color: '#00FF00', lineWidth: 5 });
                    drawLandmarks(canvasCtx, landmarks, { color: '#FF0000', lineWidth: 2 });
                }
            }
            canvasCtx.restore();

            // --- جزء استخراج البيانات ---
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const handLandmarks = results.multiHandLandmarks[0];
                landmarksDataElement.textContent = JSON.stringify(handLandmarks, null, 2);

                // --- الجزء الجديد: تسجيل البيانات ---
                if (isRecording) {
                    recordedFrames.push(handLandmarks);
                    statusElement.textContent = `الحالة: جارٍ التسجيل... (الإطارات: ${recordedFrames.length})`;
                }
            } else {
                landmarksDataElement.textContent = "في انتظار اكتشاف يد...";
            }
        }

        // --- دوال التحكم بالتسجيل ---
        function startRecording() {
            isRecording = true;
            recordedFrames = []; // إفراغ المصفوفة من أي تسجيل سابق
            startButton.disabled = true;
            stopButton.disabled = false;
            statusElement.textContent = "الحالة: جارٍ التسجيل...";
            console.log("Recording started.");
        }

        function stopAndSave() {
            isRecording = false;
            startButton.disabled = false;
            stopButton.disabled = true;
            statusElement.textContent = `الحالة: تم إيقاف التسجيل. (تم تسجيل ${recordedFrames.length} إطار)`;
            console.log("Recording stopped.");

            if (recordedFrames.length > 0) {
                saveDataToFile(recordedFrames);
            }
        }

        function saveDataToFile(data) {
            const jsonData = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            // اطلب من المستخدم إدخال اسم للحركة
            const fileName = prompt("الرجاء إدخال اسم لملف الحركة (مثلاً: hello_sign):", "my_animation");
            if (fileName) {
                a.download = `${fileName}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                console.log(`Data saved as ${fileName}.json`);
            }
        }

        // --- ربط الأزرار ---
        startButton.addEventListener('click', startRecording);
        stopButton.addEventListener('click', stopAndSave);

        // --- إعداد MediaPipe Hands والكاميرا (لا تغيير) ---
        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` } );
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        hands.onResults(onResults);
        const camera = new Camera(videoElement, { onFrame: async () => { await hands.send({ image: videoElement }); }, width: 640, height: 480 });
        camera.start();
    </script>
</body>
</html>
